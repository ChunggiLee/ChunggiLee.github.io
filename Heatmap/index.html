<html>
  <head>
  <script type="text/javascript" src="d3.v2.js"></script>
  <script type="text/javascript" src="data.js"></script>

  <style>
    body {
      margin: 0px;
      padding: 0px;
      font: 12px Arial;
    }
  </style>
  </head>
  <body>
  <div style="text-align:right; margin: 15px 150px 0px 0px;">
  	Colors: 
  	<select id="color">
  	<option value="BWR">Blue, White, Red</option>
  	<option value="GBR">Green, Black, Red</option>
  	<option value="BWR5">Blue, White, Red 5</option>
  	<option value="ROY">Red, Orange, Yellow</option>
  	</select>
  </div>

  
    <script type="text/javascript">
    //height of each row in the heatmap
    var h = 10;
    //width of each column in the heatmap
    var w = 100;

    //attach a SVG node to the document
    //height and width defined by the row/column lengths
    var width = (w * cols.length) + 400;
    
    var mySVG = d3.select("body")
      .append("svg")
      .attr("width", (w * cols.length) + 400) 
      .attr("height", (h * rows.length + 100))
      .style('position','absolute')
      .style('top',0)
      .style('left',15);
      
    var colorScale = d3.scale.linear()
        		.domain([minData, 0, maxData])
        		.range(["blue", "white", "red"]);
    var heatmapRow;
    var heatmapRects;
    
    legend(colorScale);
    CreateHeatmap()
    
    

	//console.log(data);
	
	

    //label columns (Condition name)
    var columnLabel = mySVG.selectAll(".colLabel")
      .data(cols)
      .enter().append('svg:text')
      .attr('x', function(d,i) {
        return ((i + 0.5) * w) + 75;
      })
      .attr('y', 30)
      .attr('class','label')
      .style('text-anchor','middle')
      .text(function(d) {return d;});
      
    //label row (Gene name)
    var rowLabel = mySVG.selectAll(".rowLabel")
      .data(rows)
      .enter().append('svg:text')
      .attr('x', 30)
      .attr('y', function(d,i) {
        return ((i + 3.5) * h) + 25;
      })
      .attr('class','label')
      .style('text-anchor','middle')
      .text(function(d) {return d;});
      
      

    //expression value label
    var expLab = d3.select("body")
      .append('div')
      .style('height',23)
      .style('position','absolute')
      .style('background','FFE53B')
      .style('opacity',0.8)
      .style('top',0)
      .style('padding',10)
      .style('left',40)
      .style('display','none');

    //heatmap mouse events
    heatmapRow
      .on('mouseover', function(d,i) {
        d3.select(this)
          .attr('stroke-width',1)
          .attr('stroke','black')

          output = '<b>' + rows[i] + '</b><br>';
          for (var j = 0 , count = data[i].length; j < count; j ++ ) {
            output += data[i][j][0] + ", ";
          }

          expLab
            .style('top',(i * h))
            .style('display','block')
            .html(output.substring(0,output.length - 3));
      })
      .on('mouseout', function(d,i) {
        d3.select(this)
          .attr('stroke-width',0)
          .attr('stroke','none')

        expLab
          .style('display','none')
      });
      
	d3.select("#color").on("change",function(){
    	color(this.value);
  	});
  
  	function color(value){
   		if(value=="BWR"){
   			mySVG.selectAll("g").remove();
    		colorScale = d3.scale.linear()
        		.domain([minData, 0, maxData])
        		.range(["blue", "white", "red"]);
        		legend(colorScale);
        		CreateHeatmap();
   		}else if (value=="GBR"){
   			mySVG.selectAll("g").remove();
   			var rbgColors = ["#00ff00", "#000000", "#ff0000"];
     		colorScale = d3.scale.linear()
        		.domain([minData, 0, maxData])
        		.range(rbgColors);
        		legend(colorScale);
        		CreateHeatmap();

   		}else if (value=="BWR5"){
   			mySVG.selectAll("g").remove();
   			var colors = ["#0000ff", "#0088ff", "#ffffff", "#ff0088" ,"#ff0000"];
    		colorScale = d3.scale.linear()
      		.domain([minData, -1, 0, 1, maxData])
      		.range(colors);
      		legend(colorScale);
      		CreateHeatmap();
   		}else if (value=="ROY"){
			mySVG.selectAll("g").remove();
   			var colors = ["#ffff00", "#ffa500", "#ff0000"];
    		colorScale = d3.scale.linear()
      		.domain([minData, 0, maxData])
      		.range(colors);
      		legend(colorScale);
      		CreateHeatmap();
   		}
  	}
  	
  	function legend(colorScale) {
    	var legend = mySVG.append("g")
    		.attr("class", "legend")
  			.selectAll("g")
    		.data(colorScale.domain())
  			.enter().append("g")
    		.attr("transform", function(d, i) { return "translate(" + (width - 10) + "," + (i * 20 + 50) + ")"; });

		legend.append("rect")
    		.attr("x", -18)
    		.attr("width", 18)
    		.attr("height", 18)
    		.style("fill", colorScale);

		legend.append("text")
    		.attr("x", -24)
    		.attr("y", 9)
    		.attr("dy", ".35em")
    		.style("text-anchor", "end")
    		.text(function(d) { return d; });
	} 
	
	function CreateHeatmap(){
    	//generate the heatmap
    	heatmapRow = mySVG.selectAll(".heatmap")
      		.data(data)
      		.enter().append("g");
      
		// Draw the heatmap
    	heatmapRects = heatmapRow
        	.selectAll(".rect")
        	.data(function(d) {
          	return d;
        	}).enter().append("svg:rect")
        	.attr('width',w)
        	.attr('height',h)
        	.attr('x', function(d) {
          		return (d[2] * w) + 75;
        	})
        		.attr('y', function(d) {
          		return (d[1] * h) + 50;
        	})
        	.style('fill',function(d) {
          		return colorScale(d[0]);
        	});
    	}
   </script>
  </body>
</html>